name: Code Analysis with Gemini

on:
  workflow_dispatch:  # Manual trigger from Actions tab
  schedule:
    - cron: '0 2 * * *'  # Daily at 02:00 UTC (03:00 CET in winter)
  # Uncomment to run on every push to main:
  # push:
  #   branches: [ main ]

# Minimum required permissions
permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: read

# Prevent concurrent runs
concurrency:
  group: gemini-code-analysis-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Analyze Codebase
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for better analysis
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt, clippy

      - name: Run Gemini Code Analysis
        id: gemini_analysis
        uses: google-github-actions/run-gemini-cli@v0.1.14
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: "gemini-2.5-pro"
          upload_artifacts: true
          max_tokens: 4000
          temperature: 0.2
          top_p: 0.9
          prompt: |
            Conduct a comprehensive analysis of this Tauri + Vue.js application with the following focus areas:

            ## Code Quality Analysis
            - Identify code smells, anti-patterns, and technical debt
            - Detect code duplication and suggest refactoring opportunities
            - Highlight complex functions/methods that need simplification
            
            ## Security Review
            - Identify potential security vulnerabilities (Rust unsafe blocks, JS eval, etc.)
            - Check for proper error handling and logging
            - Review data validation and sanitization
            
            ## Performance Optimization
            - Identify performance bottlenecks in both frontend and backend
            - Review memory management in Rust components
            - Suggest optimizations for network requests and state management
            
            ## Technical Debt Assessment
            - Categorize findings by severity (Critical/High/Medium/Low)
            - Provide specific code references with file paths and line numbers
            - Suggest test coverage improvements
            
            ## Output Format
            Present findings in a structured markdown format with:
            1. Executive Summary
            2. Detailed findings by category
            3. Actionable recommendations with priority levels
            4. Code examples for suggested improvements
            
            ## Context
            - Tauri v2 desktop application
            - Frontend: Vue 3 + Pinia
            - Backend: Rust with pcap and crossbeam
            - Real-time network capture functionality

      - name: Create Analysis Report
        if: ${{ steps.gemini_analysis.outputs.summary != '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create a timestamp for the report
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          REPORT_FILE="gemini-analysis-report_${TIMESTAMP}.md"
          
          # Create markdown report
          cat << 'EOF' > "$REPORT_FILE"
          # Code Analysis Report - ${{ github.repository }} @ ${{ github.sha }}
          
          **Analysis Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Repository:** ${{ github.repository }}
          **Commit:** [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          
          ## Analysis Results
          
          ${{ steps.gemini_analysis.outputs.summary }}
          
          ---
          *Generated by GitHub Actions workflow: [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          EOF
          
          # Upload report as artifact
          gh run download ${{ github.run_id }} -n "code-analysis-report"
          
          # Create GitHub issue with the report
          gh issue create \
            --title "Code Analysis Report - $(date +"%Y-%m-%d")" \
            --label "code-analysis" \
            --body-file "$REPORT_FILE"

      - name: Upload Analysis Report
        if: ${{ steps.gemini_analysis.outputs.summary != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: code-analysis-report
          path: gemini-analysis-report_*.md
          retention-days: 30

      - name: Add Summary to Job Output
        if: ${{ steps.gemini_analysis.outputs.summary != '' }}
        run: |
          {
            echo "# Code Analysis Summary"
            echo ""
            echo "A detailed code analysis has been completed. "
            echo ""
            echo "## Key Findings"
            echo ""
            echo "${{ steps.gemini_analysis.outputs.summary | replace('$', '\$') }}"
            echo ""
            echo "---"
            echo "View the full report in the artifacts section or check the created issue for more details."
          } >> $GITHUB_STEP_SUMMARY
