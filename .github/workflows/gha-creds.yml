name: Gemini – Full Repo Analysis

on:
  workflow_dispatch: # lancement manuel
  schedule:
    - cron: "0 2 * * *" # scan chaque nuit à 02:00 UTC
  push:
    branches: [main] # (optionnel) scan à chaque push sur main

permissions:
  contents: read
  issues: write # pour pouvoir ouvrir un ticket (optionnel)
  pull-requests: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Gemini CLI (full-repo scan)
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.14
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: "gemini-2.5-pro"
          upload_artifacts: true
          # Prompt = ce que tu veux comme livrable
          prompt: |
            Analyse l’intégralité de ce dépôt (Rust + Tauri + Vue).
            Objectifs :
            1) Détecte dettes techniques, duplications, hot spots de complexité.
            2) Repère les failles évidentes (panics non gérés, unwraps, fuite mémoire,
               concur. non safe, risques perf/copiage vs références, blocages UI Tauri).
            3) Propose un plan d’actions priorisé (P1/P2/P3) avec fichiers & diff suggérés.
            4) Résume dans <2000 mots; table synthèse par fichier (chemin, problème, action).
            Constraints :
            - Ignore node_modules/, target/, dist/, .git/, .github/
            - Contexte : application desktop Tauri v2, perf critique en capture réseau.
            - Mentionne ce qui est “safe to change” vs “breaking”.
            - Suggère des tests (unit/intégration) par module.

      # (Optionnel) Publie un ticket si quelque chose d'important est trouvé
      - name: Create issue with summary (if non-empty)
        if: ${{ steps.gemini.outputs.summary != '' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          printf "%s\n\n---\n\n%s" "Rapport Gemini – scan complet" "${{ steps.gemini.outputs.summary }}" \
            | gh issue create --title "Rapport Gemini – scan complet" --body-file -

      # (Optionnel) Ajoute un résumé dans l'onglet Actions
      - name: Job Summary
        run: |
          echo "## Résumé Gemini" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.gemini.outputs.summary }}" >> $GITHUB_STEP_SUMMARY
