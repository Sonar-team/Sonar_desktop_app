name: Gemini – Full Repo Analysis

on:
  workflow_dispatch:       # lancement manuel
  schedule:
    - cron: "0 2 * * *"    # scan chaque nuit à 02:00 UTC
  # push:                   # décommente si tu veux un scan à chaque push sur main
  #   branches: [ main ]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run Gemini CLI (full-repo scan)
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.14
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: "gemini-2.5-pro"
          upload_artifacts: true
          prompt: |
            Analyse l’intégralité de ce dépôt (Rust + Tauri + Vue).
            Objectifs :
            1) Détecte dettes techniques, duplications, hot spots de complexité.
            2) Repère les failles évidentes (panics non gérés, unwraps, fuite mémoire,
               concurrence non safe, risques perf/copiage vs références, blocages UI Tauri).
            3) Propose un plan d’actions priorisé (P1 / P2 / P3) + fichiers + diff suggérés.
            4) Résume dans <2000 mots ; table synthèse par fichier (chemin, problème, action).
            Contexte :
            - Application desktop Tauri v2, perf critique sur capture réseau en temps réel.
            - Technologies : Rust (backend), Vue + Pinia (frontend), pcap, crossbeam.
            Contraintes :
            - Ignore node_modules/, target/, dist/, .git/, .github/
            - Mentionne ce qui est “safe to change” vs “breaking”.
            - Suggère aussi les tests unitaires / intégration à ajouter.

      # --- Issue auto (sécurisée) --------------------------------------------------

      - name: Create issue with summary (safe)
        if: ${{ steps.gemini.outputs.summary != '' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          cat <<'EOF' > gemini-summary.md
Rapport Gemini – scan complet

---

${{ steps.gemini.outputs.summary }}
EOF

          gh issue create \
            --title "Rapport Gemini – scan complet" \
            --label "tech-debt" \
            --body-file "gemini-summary.md"

      # --- Résumé dans l’onglet Actions / Summary ----------------------------------

      - name: Job Summary (safe)
        run: |
          set -euo pipefail
          {
            echo "## Résumé Gemini"
            echo
            cat <<'EOF'
${{ steps.gemini.outputs.summary }}
EOF
          } >> "$GITHUB_STEP_SUMMARY"
