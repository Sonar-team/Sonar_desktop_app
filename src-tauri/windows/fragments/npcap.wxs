<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <!--
    Fragment 1 : déclare le fichier npcap-*.exe comme composant
    INSTALLDIR est le répertoire racine utilisé par le template Tauri.
  -->
  <Fragment>
    <DirectoryRef Id="INSTALLDIR">
      <Component Id="NpcapInstallerComponent" Guid="*">
        <File
          Id="NpcapInstallerExe"
          Source="windows\npcap-1.85.exe"
          KeyPath="yes" />
      </Component>
    </DirectoryRef>
  </Fragment>

  <!--
    Fragment 2 : détection Npcap + CustomAction pour lancer l’install
  -->
  <Fragment>
    <!-- Détection de Npcap via la base de registre -->
    <Property Id="NPCAP_INSTALLED">
      <RegistrySearch
        Id="NpcapRegSearch"
        Root="HKLM"
        Key="SOFTWARE\npcap"
        Name="WinPcapCompatible"
        Type="raw" />
    </Property>

    <!--
      Action personnalisée :
      - FileKey = NpcapInstallerExe embarqué
      - ExeCommand = "" => installeur GUI (comportement légal en version gratuite)
      - si un jour vous avez Npcap OEM :
          ExeCommand="/S /winpcap_mode=yes /admin_only=no"
    -->
    <CustomAction
      Id="InstallNpcap"
      FileKey="NpcapInstallerExe"
      ExeCommand=""
      Execute="deferred"
      Return="check"
      Impersonate="no" />

    <!--
      Séquence d’exécution :
      on lance InstallNpcap après la copie des fichiers,
      uniquement si :
        - on est en phase d’installation (NOT Installed)
        - Npcap n’est pas déjà présent (NOT NPCAP_INSTALLED)
    -->
    <InstallExecuteSequence>
      <Custom
        Action="InstallNpcap"
        After="InstallFiles">
        NOT Installed AND NOT NPCAP_INSTALLED
      </Custom>
    </InstallExecuteSequence>
  </Fragment>
</Wix>
